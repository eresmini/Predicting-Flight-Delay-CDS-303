#%%

# -*- coding: utf-8 -*-
"""
Created on Sun Oct 10 20:13:04 2021
@author: Emma
"""

import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
from sklearn.model_selection import train_test_split
from sklearn import metrics
from sklearn.metrics import accuracy_score, plot_confusion_matrix
from sklearn.ensemble import RandomForestClassifier

#%%

df3 = pd.read_csv('cleaned_dataframe.csv', index_col=0)

# converting most int64 types back to int32 (they revert when reading in the csv)
df3 = dfa.astype({
    'DEP_DELAY': int,
    'TAXI_OUT' : int,
    'WHEELS_OFF' : int,
    'WHEELS_ON' : int,
    'TAXI_IN' : int,
    'ARR_DELAY' : int,
    'SCHEDULED_ELAPSED_TIME' : int,
    'ACTUAL_ELAPSED_TIME' : int,
    'AIR_TIME' : int,
    'DISTANCE' : int
            })


#%%

# info on the dataframe - data type, memory storage, etc.
info = df3.info()

#%%

# make sure we still have no missing values
missing_df1 = df3.isnull().sum(axis=0).reset_index()
missing_df1.columns = ['variable', 'missing values']
missing_df1['filling factor (%)']=(df3.shape[0]-missing_df1['missing values'])/df3.shape[0]*100
missing_df1.sort_values('filling factor (%)').reset_index(drop = True)


#%%

delays1 = df3.FLIGHT_STATUS1.value_counts(normalize=True)
delays2 = df3.FLIGHT_STATUS2.value_counts(normalize=True)


#%%

# numerical attributes

df3.hist(figsize = [15, 15],bins=9) 
plt.show()

#%%

#categorical attributes

fig, axes = plt.subplots(nrows=3, ncols=2, figsize=(16,14), sharey=True)

categoricals = ['CARRIER','ORIGIN','DEST',
                'Year','Month','WEEKDAY']

for col, ax in zip(categoricals, axes.flatten()):
    (df3.groupby(col).sum()['FLIGHT_STATUS1'].sort_values().plot.bar(ax=ax))
    
    ax.set_title(col)
    
fig.tight_layout()


#%%

# checking for multicollinearity (heatmap)

plt.figure(figsize=(20,14))
ax = sns.heatmap(df3.corr(), cmap='viridis', center=0, annot=True)
bottom, top = ax.get_ylim()
plt.text(0,-0.6, "Variable Multicollinearity (Heat Map)", fontsize = 30, color='Black', fontstyle='normal')
ax.set_ylim(bottom + 0.5, top - 0.5)
plt.yticks(rotation=0, fontsize=14)
plt.xticks(rotation=45, fontsize=14)
plt.show()


#%%

# see how classifiers are balanced

def scaling_check1(data):
    
    case_count = df3['FLIGHT_STATUS1'].value_counts() # 'data' is our input which will be any of the 3 dataframes created
    print('Legend:')
    print(case_count)
    
    plt.figure(figsize=(10,6))
    sns.barplot(x=case_count.index, y=case_count.values)
    plt.rcParams["figure.facecolor"] = "lightblue"
    plt.title('Data Distribution', fontsize=16)
    plt.xlabel('Flight Status', fontsize=12)
    plt.ylabel('Number of Flights', fontsize=12)
    plt.xticks(range(len(case_count.index)), ['ON TIME(0)', 'DELAYED(1)'])
    plt.show()

scaling_check1(df3)

def scaling_check2(data):
    
    case_count = df3['FLIGHT_STATUS2'].value_counts() # 'data' is our input which will be any of the 3 dataframes created
    print('Legend:')
    print(case_count)
    
    plt.figure(figsize=(10,6))
    sns.barplot(x=case_count.index, y=case_count.values)
    plt.rcParams["figure.facecolor"] = "lightblue"
    plt.title('Data Distribution', fontsize=16)
    plt.xlabel('Flight Status', fontsize=12)
    plt.ylabel('Number of Flights', fontsize=12)
    plt.xticks(range(len(case_count.index)), ['On Time(0)', 'Minor Delay(1)', 'Medium Delay(2)', 'Large Delay(3)', 'Gross Delay(4)'])
    plt.show()

scaling_check2(df3)

#%%

# Binary classification model
# analyzes one airport at a time
# will ask for user input: "Choose a carrier"

def RandomForest1(df):
    
    global dfm
    dfm = df

    # User input: Choose an airline
    carrier = input('Choose a carrier: ')
    dfm = dfm[dfm['CARRIER'] == carrier]
    if dfm.empty:
        print('No flights match your criteria.')
        return None

    CARRIER_dummies = pd.get_dummies(dfm['CARRIER'], prefix='CARRIER', drop_first=True)
    ORIGIN_dummies = pd.get_dummies(dfm['ORIGIN'], prefix='ORIGIN', drop_first=True)
    DEST_dummies = pd.get_dummies(dfm['DEST'], prefix='DEST', drop_first=True)
    IATA_dummies = pd.get_dummies(dfm['IATA'], prefix='IATA', drop_first=True)
    YEAR_dummies = pd.get_dummies(dfm['Year'], prefix='Year', drop_first=True)
    MONTH_dummies = pd.get_dummies(dfm['Month'], prefix='Month', drop_first=True)
    DAY_dummies = pd.get_dummies(dfm['Day'], prefix='Day', drop_first=True)
    WEEKDAY_dummies = pd.get_dummies(dfm['WEEKDAY'], prefix='WEEKDAY', drop_first=True)
    
    dfm = dfm.drop(['CARRIER', 'ORIGIN', 'DEST', 'IATA', 'Year', 'Month', 'Day', 'WEEKDAY'], axis=1)
    dfm = pd.concat([dfm, CARRIER_dummies, ORIGIN_dummies, DEST_dummies, IATA_dummies, YEAR_dummies, MONTH_dummies, DAY_dummies, WEEKDAY_dummies], axis=1)

    # Create features (X) and labels (y)
    y = dfm['FLIGHT_STATUS1']
    X = dfm.drop(['FLIGHT_STATUS1', 'FLIGHT_STATUS2', 'DEP_DELAY'], axis=1)
    
    X_test, X_train, y_test, y_train = train_test_split(X, y, test_size=0.25, random_state=42)
    forest = RandomForestClassifier(n_estimators=100, max_depth=5, class_weight="balanced")
    fit = forest.fit(X_train, y_train)
    
    #forest.score(X_train, y_train)
    #forest.score(X_test, y_test)

    pred_rf = fit.predict(X_test)
    
    plot_confusion_matrix(fit, X, y, cmap='plasma')
    plt.show()

    print("Testing Accuracy for RandomForest Classifier: {:.6} %".format(accuracy_score(y_test, pred_rf) * 100))

RandomForest1(df3)

#%%

# multiclassification model
# analyzes one airport at a time
# will ask for user input: "Choose a carrier"

def RandomForest2(df):
    
    global dfm
    dfm = df

    # User input: Choose an airline
    carrier = input('Choose a carrier: ')
    dfm = dfm[dfm['CARRIER'] == carrier]
    if dfm.empty:
        print('No flights match your criteria.')
        return None

    CARRIER_dummies = pd.get_dummies(dfm['CARRIER'], prefix='CARRIER', drop_first=True)
    ORIGIN_dummies = pd.get_dummies(dfm['ORIGIN'], prefix='ORIGIN', drop_first=True)
    DEST_dummies = pd.get_dummies(dfm['DEST'], prefix='DEST', drop_first=True)
    IATA_dummies = pd.get_dummies(dfm['IATA'], prefix='IATA', drop_first=True)
    YEAR_dummies = pd.get_dummies(dfm['Year'], prefix='Year', drop_first=True)
    MONTH_dummies = pd.get_dummies(dfm['Month'], prefix='Month', drop_first=True)
    DAY_dummies = pd.get_dummies(dfm['Day'], prefix='Day', drop_first=True)
    WEEKDAY_dummies = pd.get_dummies(dfm['WEEKDAY'], prefix='WEEKDAY', drop_first=True)
    
    dfm = dfm.drop(['CARRIER', 'ORIGIN', 'DEST', 'IATA', 'Year', 'Month', 'Day', 'WEEKDAY'], axis=1)
    dfm = pd.concat([dfm, CARRIER_dummies, ORIGIN_dummies, DEST_dummies, IATA_dummies, YEAR_dummies, MONTH_dummies, DAY_dummies, WEEKDAY_dummies], axis=1)

    # Create features (X) and labels (y)
    y = dfm['FLIGHT_STATUS2']
    X = dfm.drop(['FLIGHT_STATUS1', 'FLIGHT_STATUS2', 'DEP_DELAY'], axis=1)
    
    X_test, X_train, y_test, y_train = train_test_split(X, y, test_size=0.25, random_state=42)
    forest = RandomForestClassifier(n_estimators=100, max_depth=5,
                                    class_weight="balanced", n_jobs=-1)
    fit = forest.fit(X_train, y_train)
    
    #forest.score(X_train, y_train)
    #forest.score(X_test, y_test)

    pred_rf = fit.predict(X_test)
    
    plot_confusion_matrix(fit, X, y, cmap='plasma')
    plt.show()
    
    print("Testing Accuracy for RandomForest Classifier: {:.6} %".format(accuracy_score(y_test, pred_rf) * 100))

RandomForest2(df3)
